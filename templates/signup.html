<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnSync Signup</title>
    <link rel="stylesheet" href="../static/css/style-updated.css">
    <link rel="stylesheet" href="../static/css/style-login.css">
</head>

<body>
    <signup-overlay id="signup-overlay">
        <!-- <button id="close-login" class="link-tertiary">Close</button> -->
        <form id="signup-form" method="post">
            <div class="login-container">
                <div class="heading">Signup</div>
                <div id="step1" class="form-step">
                    <div class="sup-username">
                        <input type="text" name="username" id="username" placeholder="Username">
                        <span class="material-symbols-outlined" id="username-state" data-style="inactive"
                            style="font-size: 28px;">
                            check
                        </span>
                    </div>
                    <script>

                        document.addEventListener('DOMContentLoaded', function () {
                            var passCon = document.querySelector('.sup-password');
                            var notPassCon = document.querySelector('.sup-notpass');
                            var uiBtns = document.querySelectorAll('.ui-button-3');
                            uiBtns[0].style.display = 'none';
                            uiBtns.forEach(element => {
                                element.style.opacity = '0';
                            });
                            var otpField = document.querySelector(".otp-fields");
                            otpField.style.display = "none";
                            for (var i = 1; i <= 6; i++) {
                                var inputField = document.getElementById('otp-field-' + i);
                                inputField.style.opacity = "0";
                            }
                            // Your code to execute after the document has loaded
                            passCon.style.backgroundColor = "var(--polar)";
                            passCon.style.color = "var(--swan)";
                            passCon.style.cursor = "not-allowed";
                            notPassCon.style.backgroundColor = "var(--polar)";
                            notPassCon.style.color = "var(--swan)";
                            notPassCon.style.cursor = "not-allowed";
                            // You can perform any action here, such as manipulating the DOM or making AJAX requests.
                        });

                        document.querySelector("#username").addEventListener('input', async function () {
                            var state = document.querySelector('#username-state');
                            var passCon = document.querySelector('.sup-password');

                            var pass = document.querySelector('#password');
                            var notPass = document.querySelector('#not-pass');

                            console.log(await checkUsername(this.value.trim()));
                            if (await checkUsername(this.value) == true && this.value.trim() != "") {
                                console.log("Valid Input");
                                state.style.backgroundColor = 'var(--feather-green)';
                                state.style.color = "var(--snow)";
                                pass.disabled = false;
                                notPass.disabled = false;
                                passCon.style.backgroundColor = "var(--snow)";
                                passCon.style.color = "var(--eel)";
                                passCon.style.cursor = "pointer";
                            } else if (this.value.trim() == "") {
                                state.style.backgroundColor = "var(--polar)";
                                state.style.color = "var(--swan)";
                                pass.disabled = true;
                                notPass.disabled = true;
                                passCon.style.backgroundColor = "var(--polar)";
                                passCon.style.color = "var(--swan)";
                                passCon.style.cursor = "pointer";
                            } else {
                                state.style.backgroundColor = "var(--cardinal)";
                                state.style.color = "var(--snow)";
                                pass.disabled = true;
                                notPass.disabled = true;
                                passCon.style.backgroundColor = "var(--polar)";
                                passCon.style.color = "var(--swan)";
                                passCon.style.cursor = "pointer";
                            }


                        });
                    </script>
                    <div class="sup-password" data-style="inactive">
                        <input type="password" name="password" id="password" placeholder="Password" disabled>
                        <span class="material-symbols-outlined" id="password-state" data-style="inactive"
                            style="font-size: 28px;">
                            check
                        </span>
                    </div>
                    <script>
                        document.querySelector("#password").addEventListener('input', async function () {
                            var state = document.querySelector('#password-state');
                            var passCon = document.querySelector('.sup-password');

                            var pass = document.querySelector('#password');
                            var notPass = document.querySelector('.sup-notpass');

                            if (validatePassword(this.value.trim()) == true && this.value.trim() != "") {
                                console.log("Valid Password");
                                state.style.backgroundColor = 'var(--feather-green)';
                                state.style.color = "var(--snow)";
                                // pass.disabled = false;
                                notPass.disabled = false;
                                notPass.style.backgroundColor = "var(--snow)";
                                notPass.style.color = "var(--eel)";
                                notPass.style.cursor = "pointer";
                            } else if (this.value.trim() == "") {
                                state.style.backgroundColor = "var(--polar)";
                                state.style.color = "var(--swan)";
                                // pass.disabled = true;
                                notPass.disabled = true;
                                // passCon.style.backgroundColor = "var(--polar)";
                                // passCon.style.color = "var(--swan)";
                                // passCon.style.cursor = "pointer";
                            } else {
                                state.style.backgroundColor = "var(--cardinal)";
                                state.style.color = "var(--snow)";
                                // pass.disabled = true;
                                notPass.disabled = true;
                                // passCon.style.backgroundColor = "var(--polar)";
                                // passCon.style.color = "var(--swan)";
                                // passCon.style.cursor = "pointer";
                            }

                        });
                        function validatePassword(password) {
                            // Regular expressions to check for uppercase, lowercase, digit, and special character
                            var upperCaseRegex = /[A-Z]/;
                            var lowerCaseRegex = /[a-z]/;
                            var digitRegex = /[0-9]/;
                            var specialCharRegex = /[!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]/;

                            // Check if the password meets the criteria
                            var isLengthValid = password.length >= 8;
                            var hasUpperCase = upperCaseRegex.test(password);
                            var hasLowerCase = lowerCaseRegex.test(password);
                            var hasDigit = digitRegex.test(password);
                            var hasSpecialChar = specialCharRegex.test(password);

                            // Return true if all criteria are met, otherwise return false
                            return true;
                            return isLengthValid && hasUpperCase && hasLowerCase && hasDigit && hasSpecialChar;
                        }
                    </script>
                    <div class="sup-notpass">
                        <input type="password" name="not-pass" id="not-pass" placeholder="Re-confirm Password" disabled>
                        <span class="material-symbols-outlined" id="notpassword-state" data-style="inactive"
                            style="font-size: 28px;">
                            check
                        </span>
                    </div>
                    <script>
                        document.querySelector("#not-pass").addEventListener('input', async function () {
                            var state = document.querySelector('#notpassword-state');
                            var passCon = document.querySelector('.sup-notpass');
                            var uiBtns = document.querySelectorAll('.ui-button-3');

                            var pass = document.querySelector('#password');
                            var notPass = document.querySelector('#not-pass');

                            if (this.value == pass.value && this.value.trim() != "") {
                                console.log("Valid Password");
                                state.style.backgroundColor = 'var(--feather-green)';
                                state.style.color = "var(--snow)";
                                uiBtns[1].style.opacity = '1';


                            } else if (this.value.trim() == "") {
                                state.style.backgroundColor = "var(--polar)";
                                state.style.color = "var(--swan)";
                                uiBtns.forEach(element => {
                                    element.style.opacity = '0';
                                });

                            } else {
                                state.style.backgroundColor = "var(--cardinal)";
                                state.style.color = "var(--snow)";
                                uiBtns.forEach(element => {
                                    element.style.opacity = '0';
                                });

                            }

                        });
                    </script>
                    <span class="less-imp-text" style="max-width: 80%;">Password must be at least 8 characters with <u>a
                            uppercase, a lowercase, a digit, and a special character</u>.</span>
                    <!-- <span>or continue with</span> 
                        <a href="#" class="link-primary">Google</a> -->
                </div>
                <div id="step2" class="form-step">
                    <div class="sup-email">
                        <input type="email" name="email" id="email" placeholder="Enter Your Email" required>
                        <span class="material-symbols-outlined" id="email-state" data-style="inactive"
                            style="font-size: 28px;">
                            check
                        </span>
                    </div>
                    <button class="ui-button-3 send-mail-btn"><span class="material-symbols-outlined" style="font-size: 28px;">
                        outgoing_mail
                        </span>&nbsp;Send Mail</button>
                    <script>
                        function validateEmail(email) {
                            // Regular expression pattern for validating email addresses
                            var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            return regex.test(email);
                        }
                        document.querySelector("#email").addEventListener('input', async function () {
                            var state = document.querySelector('#email-state');
                            var passCon = document.querySelector('.sup-password');

                            var pass = document.querySelector('#password');
                            var notPass = document.querySelector('#not-pass');

                            // console.log(await checkUsername(this.value.trim()));
                            console.log("****************************************************************");

                            console.log(validateEmail(this.value.trim()));
                            console.log(this.value.trim() != "");
                            console.log(await checkEmail(this.value.trim()) == true);
                            console.log("****************************************************************");

                            // console.log(validateEmail(this.value.trim()) && this.value.trim() != "" && await checkEmail(this.value.trim()) == 'true');
                            if (validateEmail(this.value.trim()) && this.value.trim() != "" && await checkEmail(this.value.trim()) == true) {
                                console.log("Valid Email");
                                state.style.backgroundColor = 'var(--feather-green)';
                                state.style.color = "var(--snow)";
                                var otpField = document.querySelector(".otp-fields");
                                otpField.style.display = "flex";
                                for (var i = 1; i <= 6; i++) {
                                    var inputField = document.getElementById('otp-field-' + i);
                                    inputField.style.opacity = "1";

                                }
                            } else if (this.value.trim() == "") {
                                state.style.backgroundColor = "var(--polar)";
                                state.style.color = "var(--swan)";

                            } else {
                                state.style.backgroundColor = "var(--cardinal)";
                                state.style.color = "var(--snow)";

                            }


                        });
                    </script>
                    <div class="otp-fields">
                        <input type="text" maxlength="1" id="otp-field-1"
                            onkeyup="moveToNextField(event, 'otp-field-2')">
                        <input type="text" maxlength="1" id="otp-field-2"
                            onkeyup="moveToNextField(event, 'otp-field-3')">
                        <input type="text" maxlength="1" id="otp-field-3"
                            onkeyup="moveToNextField(event, 'otp-field-4')">
                        <input type="text" maxlength="1" id="otp-field-4"
                            onkeyup="moveToNextField(event, 'otp-field-5')">
                        <input type="text" maxlength="1" id="otp-field-5"
                            onkeyup="moveToNextField(event, 'otp-field-6')">
                        <input type="text" maxlength="1" id="otp-field-6">
                    </div>

                    <span id="otp-tip" class="less-imp-text">Enter OTP sent to your Email address.</span>
                    <!-- <input type="password" id="otp-field" name="opt_space"
                        placeholder="Confirm OTP sent on to your Email" maxlength="6"> -->
                    <button id="verify-otp" class="ui-button">
                        Verify&nbsp;<span class="material-symbols-outlined">
                            Pin
                        </span>
                    </button>
                    <a class="link-primary" id="signup-link">Signup</a>
                    <script>
                        function moveToNextField(event, nextFieldId) {
                            var maxLength = parseInt(event.target.getAttribute('maxlength'));
                            var currentLength = event.target.value.length;
                            if (currentLength >= maxLength) {
                                document.getElementById(nextFieldId).focus();
                            }
                        }
                    </script>
                </div>
                <div class="nav-form">
                    <button id="prev-button" class="ui-button-3">
                        <span class="material-symbols-outlined" style="font-size: 28px;">
                            arrow_back
                        </span>

                    </button>
                    <button id="next-button" class="ui-button-3">
                        <span class="material-symbols-outlined" style="font-size: 28px;">
                            arrow_forward
                        </span>
                    </button>
                    <script>
                        document.querySelector("#next-button").addEventListener('click', function () {
                            var uiBtns = document.querySelectorAll('.ui-button-3');
                            uiBtns[0].style.display = "flex";
                            uiBtns[0].style.opacity = "1";

                        });
                        document.querySelector("#prev-button").addEventListener('click', function () {
                            var step = document.querySelector('.form-step-2');
                            step.classList.remove('form-step-2');
                            step.classList.add('form-step');
                        });
                    </script>
                </div>
            </div>
        </form>
    </signup-overlay>
    <!-- <script src="../static/js/signup.js"></script> -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const formSteps = document.querySelectorAll('.form-step');
            let currentStep = 0;
            updateNavButtons();

            document.querySelector('#prev-button').addEventListener('click', function (e) {
                e.preventDefault();
                currentStep = Math.max(0, currentStep - 1);
                updateNavButtons();
            });

            document.querySelector('#next-button').addEventListener('click', function (e) {
                e.preventDefault();
                currentStep = Math.min(formSteps.length - 1, currentStep + 1);
                updateNavButtons();
            });

            function updateNavButtons() {
                formSteps.forEach((step, index) => {
                    step.style.display = index === currentStep ? 'flex' : 'none';
                });

                const prevButton = document.querySelector('#prev-button');
                const nextButton = document.querySelector('#next-button');
                const signupLinkButton = document.querySelector('#signup-link');

                prevButton.disabled = currentStep === 0;
                nextButton.disabled = currentStep === formSteps.length - 1;

                // if (currentStep === formSteps.length - 1) {
                //     signupLinkButton.disabled = false;
                // } else {
                //     signupLinkButton.disabled = true;
                // }
            }
        });


        async function checkUsername(username) {
            const response = await fetch('/check-username-availability', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `username=${username}`
            });
            const data = await response.json();
            return data.message === 'Username available';
        }

        async function checkEmail(email) {
            const response = await fetch('/check-email-availability', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `email=${email}`
            });
            const data = await response.json();
            return data.message === 'Email available';
        }

        async function verifyEmail(email) {
            const response = await fetch('/send-verification-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email })
            });
            const data = await response.json();
            // alert(data.otp);
            return data.otp;
        }

        function verifyOtp(otp) {
            document.getElementById('verify-otp').addEventListener('click', function (event) {
                event.preventDefault(); // Prevent default form submission behavior
                var OTP = '';
                // Loop through each OTP field and concatenate its value
                for (var i = 1; i <= 6; i++) {
                    var inputField = document.getElementById('otp-field-' + i);
                    OTP += inputField.value;
                }
                const enteredOTP = parseInt(OTP);
                const actualOTP = parseInt(otp); // Assuming `otp` is a global variable containing the actual OTP
                // alert("Tumne enter kiya hain!", enteredOTP);
                console.log(enteredOTP + "Entered OTP");
                console.log(actualOTP + "Actual OTP");
                console.log(enteredOTP === actualOTP);
                if (enteredOTP === actualOTP) {
                    // OTP verification successful
                    // Proceed with form submission
                    const formData = new FormData(document.getElementById('signup-form'));
                    fetch('/sign-up', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => {
                            if (response.ok) {
                                // Form submission successful
                                alert("Form submitted successfully!");
                                window.location.href = 'http://127.0.0.1:8888/login';
                            } else {
                                // Form submission failed
                                alert("Error submitting form. Please try again.");
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert("An error occurred while submitting the form.");
                        });
                } else {
                    // OTP verification failed
                    // Show error message or take appropriate action
                    alert('Invalid OTP. Please try again.');
                }
            });
        }

        document.querySelector('#signup-link').addEventListener('click', async function (e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const not_pass = document.getElementById('not-pass').value;
            const email = document.getElementById('email').value;
            // const isUsernameAvailable = await checkUsername(username);
            // const isEmailAvailable = await checkEmail(email);

            // if (isEmailAvailable && isUsernameAvailable && password === not_pass) { console.log('Username is available and passwords match. Submitting form...'); }

            if (password === not_pass) {
                const otp = await verifyEmail(email);
                // alert("Tumhara otp hain..." + otp);
                
                verifyOtp(otp);

            } else if (!isUsernameAvailable) {
                alert('Username already exists. Please choose a different username.');
            } else if (!isEmailAvailable) {
                alert('Email already exists. Please choose a different email.');
            } else if (password !== not_pass) {
                alert('Passwords do not match. Please re-enter your passwords.');
            }
        });


    </script>
</body>

</html>